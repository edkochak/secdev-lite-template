# S05 - Матрица вариантов для R-02: SQL injection и несанкционированный доступ

---

## 0) Контекст риска (из S04)

* **Risk-ID:** `R-02`     **Threat:** `T, I`
* **DFD element/edge:** `Edge: S→D, Node: D`
* **NFR link (ID):** `NFR-008 (Data-Integrity)`
* **L×I (1-5):** `L=4, I=5, Score=20`
* **Ограничения/предпосылки:** Существующая архитектура с прямыми SQL-запросами, ORM частично используется, публичные API эндпойнты, критичные данные в БД

---

## 1) Критерии и шкалы (1-5)

**Польза (чем больше - тем лучше, ↑):**

* **Security impact (↑):** насколько альтернатива снижает риск (предотвращает/обнаруживает/сдерживает).
* **Blast radius reduction (↑):** насколько сужает возможный ущерб (только один тенант/аккаунт/фича вместо всего сервиса).

**Стоимость/сложность (чем меньше - тем лучше, ↓):**

* **Complexity (↓):** сложность внедрения (код/конфиг/политики).
* **Time-to-mitigate (↓):** сколько времени до эффекта (в днях/спринтах).
* **Dependencies (↓):** внешние/внутренние зависимости (команды, провайдеры, миграции).

**Итоговые метрики:**

* **Benefit = Security impact + Blast radius reduction**
* **Cost = Complexity + Time-to-mitigate + Dependencies**
* **Net = Benefit − Cost**  *(чем больше, тем привлекательнее)*

---

## 2) Таблица сравнения вариантов

| Alternative | Summary (1-2 фразы) | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes |
| ----------- | ------------------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | ----- |
| A           | ORM с параметризованными запросами + миграция | 5 | 4 | 3 | 4 | 2 | **9** | **9** | **0** | Полная защита, но требует рефакторинга |
| B           | Prepared Statements + Validation на DAO слое | 5 | 3 | 2 | 2 | 1 | **8** | **5** | **+3** | Быстрая реализация, эффективная защита |
| C           | Database WAF + Query Pattern Blocking | 3 | 5 | 4 | 3 | 4 | **8** | **11** | **-3** | Внешняя защита, но много зависимостей |

---

## 3) Тай-брейкеры при равенстве Net

* **Compliance/Privacy:** A и B обеспечивают полное соответствие, C может иметь пропуски
* **Maintainability:** B проще в сопровождении, не меняет архитектуру кардинально
* **Team fit:** команда знает prepared statements, ORM потребует обучения
* **Observability:** B сохраняет существующие метрики, A требует новый мониторинг
* **Rollback safety:** B легко откатить, A потребует database rollback

---

## 4) Решение (для переноса в ADR)

* **Chosen alternative:** `B`
* **Почему:** Лучший Net score (+3), высокий security impact (5), низкая сложность (2), быстрая реализация (2 спринт-дня), минимальные зависимости. Prepared statements - проверенное решение с хорошим соотношением безопасность/сложность.
* **ADR candidate (название):** `Parameterized Queries + DAO Input Validation`
* **Связки:** Risk-ID `R-02`, NFR-ID `NFR-008`, DFD `Edge: S→D, Node: D`
* **Следующие шаги (минимум):** 
  - Заменить все прямые SQL-запросы на prepared statements
  - Добавить валидацию входных параметров на DAO уровне
  - Настроить канонизацию данных (strings, dates, phones)
  - Добавить SAST правила для детекции SQL injection
  - Создать unit-тесты на SQL injection попытки

---

## 5) Самопроверка

* [x] Риск и контекст из S04 указаны (Risk-ID, DFD, NFR-ID, L×I).
* [x] Сравнили **минимум 2 альтернативы**.
* [x] Заполнены все критерии 1-5; посчитаны Benefit/Cost/Net.
* [x] Описаны тай-брейкеры (если Net равен).
* [x] Принято решение и зафиксирован **ADR candidate**.
* [x] Готовы перенести решение в **`S05_ADR_parameterized_queries.md`** (шаблон ADR).