# S05 - Матрица вариантов для R-01: PII утечка в логах

---

## 0) Контекст риска (из S04)

* **Risk-ID:** `R-01`     **Threat:** `I`
* **DFD element/edge:** `Edge: U→A, S→P`
* **NFR link (ID):** `NFR-005 (Privacy/PII)`
* **L×I (1-5):** `L=4, I=5, Score=20`
* **Ограничения/предпосылки:** JSON-логи, структурированное логирование, существующие middleware для ошибок, GDPR требования

---

## 1) Критерии и шкалы (1-5)

**Польза (чем больше - тем лучше, ↑):**

* **Security impact (↑):** насколько альтернатива снижает риск (предотвращает/обнаруживает/сдерживает).
* **Blast radius reduction (↑):** насколько сужает возможный ущерб (только один тенант/аккаунт/фича вместо всего сервиса).

**Стоимость/сложность (чем меньше - тем лучше, ↓):**

* **Complexity (↓):** сложность внедрения (код/конфиг/политики).
* **Time-to-mitigate (↓):** сколько времени до эффекта (в днях/спринтах).
* **Dependencies (↓):** внешние/внутренние зависимости (команды, провайдеры, миграции).

**Итоговые метрики:**

* **Benefit = Security impact + Blast radius reduction**
* **Cost = Complexity + Time-to-mitigate + Dependencies**
* **Net = Benefit − Cost**  *(чем больше, тем привлекательнее)*

---

## 2) Таблица сравнения вариантов

| Alternative | Summary (1-2 фразы) | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes |
| ----------- | ------------------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | ----- |
| A           | PII Masking + Allowlist полей в логах | 5 | 4 | 2 | 2 | 1 | **9** | **5** | **+4** | Высокий эффект, простая реализация на middleware |
| B           | Structured Logging + Field Filtering | 4 | 3 | 3 | 3 | 2 | **7** | **8** | **-1** | Требует рефакторинг всех логов, больше зависимостей |
| C           | Centralized Log Processing + PII Detection | 4 | 5 | 4 | 4 | 4 | **9** | **12** | **-3** | Сложное решение с внешними зависимостями |

---

## 3) Тай-брейкеры при равенстве Net

* **Compliance/Privacy:** A полностью соответствует GDPR, B частично, C требует аудита
* **Maintainability:** A проще поддерживать, единый middleware
* **Team fit:** команда знает middleware паттерн, нет экспертизы в log processing
* **Observability:** A сохраняет структуру логов, B может нарушить форматы
* **Rollback safety:** A легко откатить через конфиг, B/C требуют изменений кода

---

## 4) Решение (для переноса в ADR)

* **Chosen alternative:** `A`
* **Почему:** Максимальный Net score (+4), высокий security impact (5), минимальная сложность (2), быстрая реализация (2 спринт-дня), нет внешних зависимостей. Команда имеет экспертизу в middleware, легкий rollback.
* **ADR candidate (название):** `PII Masking + RFC7807 Error Format`
* **Связки:** Risk-ID `R-01`, NFR-ID `NFR-005`, DFD `Edge: U→A, S→P`
* **Следующие шаги (минимум):** 
  - Создать middleware для маскирования PII в логах
  - Добавить allowlist разрешенных полей для логирования
  - Настроить RFC7807 формат для ошибок без PII
  - Обновить retention политику для PII до 365 дней
  - Добавить тесты на маскирование в логах

---

## 5) Самопроверка

* [x] Риск и контекст из S04 указаны (Risk-ID, DFD, NFR-ID, L×I).
* [x] Сравнили **минимум 2 альтернативы**.
* [x] Заполнены все критерии 1-5; посчитаны Benefit/Cost/Net.
* [x] Описаны тай-брейкеры (если Net равен).
* [x] Принято решение и зафиксирован **ADR candidate**.
* [x] Готовы перенести решение в **`S05_ADR_pii_masking.md`** (шаблон ADR).