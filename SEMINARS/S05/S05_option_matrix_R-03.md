# S05 - Матрица вариантов для R-03: JWT token reuse/hijacking

---

## 0) Контекст риска (из S04)

* **Risk-ID:** `R-03`     **Threat:** `S`
* **DFD element/edge:** `Edge: U→A, Node: A`
* **NFR link (ID):** `NFR-003 (Security-AuthN)`
* **L×I (1-5):** `L=4, I=4, Score=16`
* **Ограничения/предпосылки:** Публичная поверхность атаки, существующая JWT архитектура, stateless сервисы, HTTPS only, требования к совместимости с мобильными клиентами

---

## 1) Критерии и шкалы (1-5)

**Польза (чем больше - тем лучше, ↑):**

* **Security impact (↑):** насколько альтернатива снижает риск (предотвращает/обнаруживает/сдерживает).
* **Blast radius reduction (↑):** насколько сужает возможный ущерб (только один тенант/аккаунт/фича вместо всего сервиса).

**Стоимость/сложность (чем меньше - тем лучше, ↓):**

* **Complexity (↓):** сложность внедрения (код/конфиг/политики).
* **Time-to-mitigate (↓):** сколько времени до эффекта (в днях/спринтах).
* **Dependencies (↓):** внешние/внутренние зависимости (команды, провайдеры, миграции).

**Итоговые метрики:**

* **Benefit = Security impact + Blast radius reduction**
* **Cost = Complexity + Time-to-mitigate + Dependencies**
* **Net = Benefit − Cost**  *(чем больше, тем привлекательнее)*

---

## 2) Таблица сравнения вариантов

| Alternative | Summary (1-2 фразы) | Security impact (↑,1-5) | Blast radius reduction (↑,1-5) | Complexity (↓,1-5) | Time-to-mitigate (↓,1-5) | Dependencies (↓,1-5) | **Benefit** | **Cost** | **Net** | Notes |
| ----------- | ------------------- | ----------------------: | -----------------------------: | -----------------: | -----------------------: | -------------------: | ----------: | -------: | ------: | ----- |
| A           | JWT TTL 15min + Refresh Token + Key Rotation | 4 | 3 | 2 | 2 | 2 | **7** | **6** | **+1** | Быстрая реализация, минимизирует окно атаки |
| B           | mTLS Client Authentication | 5 | 4 | 4 | 4 | 5 | **9** | **13** | **-4** | Максимальная защита, но сложная реализация |
| C           | JWT + Device Fingerprinting + IP Binding | 3 | 2 | 3 | 3 | 3 | **5** | **9** | **-4** | Частичная защита, проблемы с мобильностью |

---

## 3) Тай-брейкеры при равенстве Net

* **Compliance/Privacy:** A соответствует стандартам, B требует PKI управления, C может нарушать приватность
* **Maintainability:** A проще в эксплуатации, единообразное key management
* **Team fit:** команда знает JWT, нет экспертизы в mTLS/PKI
* **Observability:** A сохраняет существующую трассировку токенов
* **Rollback safety:** A легко откатить через конфигурацию TTL

---

## 4) Решение (для переноса в ADR)

* **Chosen alternative:** `A`
* **Почему:** Лучший Net score (+1), сбалансированное решение по security impact (4) и сложности (2), быстрая реализация (2 спринт-дня), низкие зависимости. Короткий TTL значительно сужает окно атаки при краже токена.
* **ADR candidate (название):** `JWT Short TTL + Refresh + Key Rotation`
* **Связки:** Risk-ID `R-03`, NFR-ID `NFR-003`, DFD `Edge: U→A, Node: A`
* **Следующие шаги (минимум):** 
  - Настроить Access Token TTL = 15 минут
  - Реализовать Refresh Token механизм (TTL = 7 дней)
  - Настроить автоматическую ротацию JWKS ключей
  - Добавить logout/blacklist для refresh токенов
  - Настроить clock skew tolerance ±60 секунд

---

## 5) Самопроверка

* [x] Риск и контекст из S04 указаны (Risk-ID, DFD, NFR-ID, L×I).
* [x] Сравнили **минимум 2 альтернативы**.
* [x] Заполнены все критерии 1-5; посчитаны Benefit/Cost/Net.
* [x] Описаны тай-брейкеры (если Net равен).
* [x] Принято решение и зафиксирован **ADR candidate**.
* [x] Готовы перенести решение в **`S05_ADR_jwt_short_ttl.md`** (шаблон ADR).